
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</title>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent: #4a9eff;
            --accent-hover: #3a8eef;
            --border: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .current-date {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        .controls-panel {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .days-navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .day-btn {
            flex: 1;
            padding: 15px 10px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 3px solid transparent;
        }

        .day-btn.active {
            background: var(--accent);
            color: white;
            border-bottom: 3px solid var(--accent-hover);
        }

        .menu-content {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .menu-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--accent);
            text-align: center;
        }

        .nutrition-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 20px;
        }

        .nutrition-table th {
            background: var(--accent);
            color: white;
            padding: 10px 4px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .nutrition-table td {
            padding: 6px 4px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .nutrition-table tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        .meal-total-row {
            background: var(--bg-secondary) !important;
            font-weight: bold;
            border-top: 2px solid var(--accent);
        }

        .day-total-row {
            background: var(--accent) !important;
            color: white;
            font-weight: bold;
        }

       
        .weight-input {
            width: 50px;
            padding: 2px;
            border: 1px solid var(--border);
            border-radius: 3px;
            background: var(--bg-primary);
            color: var(--text-primary);
            text-align: center;
        }

        .delete-btn {
            width: 18px;
            height: 18px;
            border: 1px solid white;
            border-radius: 50%;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            margin-left: 5px;
        }

        .ingredient-cell {
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-align: left !important;
}

        .meal-spacer {
            height: 15px;
            background: transparent !important;
            border: none !important;
        }

        .calculations-section, .kbju-table-section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            display: none;
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--accent);
            text-align: center;
        }

        .ingredient-not-found {
            background-color: #ff4444 !important;
            color: white !important;
            border: 1px solid #ff0000 !important;
        }

        .ingredient-suggest {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .suggest-btn {
            width: 18px;
            height: 18px;
            border: 1px solid #ff4444;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .suggestions-dropdown {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 5px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .suggestion-item:hover {
            background: var(--accent);
            color: white;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .time-cell {
            position: relative;
            cursor: pointer;
        }

        .time-display {
            padding: 4px 8px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .time-display:hover {
            background-color: var(--accent);
        }

        .time-dropdown {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 5px;
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            width: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .time-option {
            padding: 6px 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-align: center;
        }

        .time-option:hover {
            background: var(--accent);
            color: white;
        }

        .time-option:last-child {
            border-bottom: none;
        }
    
.ingredient-header {
    position: relative;
}

.add-ingredient-header-btn {
    position: absolute;
    right: 5px;
    bottom: 3px;
    width: 18px;
    height: 18px;
    background: #00aa00;
    color: white;
    border: none;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dish-cell {
    position: relative;
}

.dish-add-btn {
    position: absolute;
    right: 6px;
    bottom: 6px;
    width: 18px;
    height: 18px;
    background: #00aa00;
    color: white;
    border: none;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}


</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="current-date" id="currentDate"></div>
            <div class="controls-panel">
                <button class="control-btn" id="loadMenuBtn" onclick="loadMenuFromTxt()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</button>
            </div>
        </div>
        
        <div class="days-navigation" id="daysNav"></div>
        
        <div class="menu-content" id="menuContent">
            <div class="menu-title" id="menuTitle">–ú–µ–Ω—é –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
            <table class="nutrition-table" id="menuTable">
                <thead>
                    <thead>
    
    <tr>
        <th>–í—Ä–µ–º—è</th>
        <th>–ü—Ä–∏—ë–º –ø–∏—â–∏</th>
        <th>–ë–ª—é–¥–æ</th>
        <th>–°–æ—Å—Ç–∞–≤ –±–ª—é–¥–∞</th>
        <th>–í–µ—Å</th>
        <th>–ë</th>
        <th>–ñ</th>
        <th>–£</th>
        <th>–ö–ö–ª</th>
        <th>–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</th>
    

</thead>
                </thead>
                <tbody id="menuTableBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </tbody>
            </table>
        </div>

        <div class="calculations-section" id="calculationsSection">
            <div class="section-title">–ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é</div>
            <div id="calculationsContent">
                <!-- –î–∞–Ω–Ω—ã–µ –ø–æ–¥—Å—á–µ—Ç–æ–≤ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>

        <div class="kbju-table-section" id="kbjuTableSection">
            <div class="section-title">–¢–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
            <button class="control-btn" onclick="loadKbjuFromTxt()" style="margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ö–ë–ñ–£</button>
<button class="control-btn" onclick="showAddProductModal()" style="margin-bottom: 20px;">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>            
<div id="kbjuTableContent">
                <!-- –¢–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ -->
<div id="addProductModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: var(--bg-card); padding: 30px; border-radius: 10px; width: 400px; border: 1px solid var(--border);">
        <h3 style="margin-bottom: 20px; color: var(--accent); text-align: center;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:</label>
            <input type="text" id="newProductName" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); padding: 8px; border-radius: 5px;">
            
            <label>–ë–µ–ª–∫–∏ (–≥):</label>
            <input type="number" step="0.1" id="newProductProteins" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); padding: 8px; border-radius: 5px;">
            
            <label>–ñ–∏—Ä—ã (–≥):</label>
            <input type="number" step="0.1" id="newProductFats" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); padding: 8px; border-radius: 5px;">
            
            <label>–£–≥–ª–µ–≤–æ–¥—ã (–≥):</label>
            <input type="number" step="0.1" id="newProductCarbs" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); padding: 8px; border-radius: 5px;">
            
            <label>–ö–∫–∞–ª:</label>
            <input type="number" step="0.1" id="newProductCalories" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); padding: 8px; border-radius: 5px;">
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
    <button class="control-btn" onclick="addNewProduct()" id="modalActionButton">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button class="control-btn" onclick="deleteProduct()" id="modalDeleteButton" style="background: #ff4444; display: none;">–£–¥–∞–ª–∏—Ç—å</button>
    <button class="control-btn" onclick="hideAddProductModal()" style="background: var(--bg-secondary);">–û—Ç–º–µ–Ω–∞</button>
</div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
<div id="productSelectModal" style="display: none; position: fixed; top: 0; left: 0; 
width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; 
justify-content: center; align-items: center;">
    <div style="background: var(--bg-card); padding: 20px; border-radius: 10px; 
    border: 1px solid var(--border); max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 10px; color: var(--accent); text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</h3>
        <div id="productSelectTableContainer" style="overflow-y: auto; flex-grow: 1; border: 1px solid var(--border); border-radius: 5px; max-height: 400px;">
            <!-- —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <button class="control-btn" style="background: var(--bg-secondary);" onclick="closeProductSelectModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>


    <script>
        // –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        let menuData = {
            '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': {
                '–ó–∞–≤—Ç—Ä–∞–∫': {
                    dish: '–û–º–ª–µ—Ç —Å –æ–≤–æ—â–∞–º–∏',
                    ingredients: [
                        { name: '–Ø–π—Ü–∞', weight: 100, proteins: 13, fats: 11, carbs: 1, calories: 155 },
                        { name: '–ü–æ–º–∏–¥–æ—Ä—ã', weight: 100, proteins: 1, fats: 0, carbs: 4, calories: 20 }
                    ],
                    recipe: '–í–∑–±–µ–π—Ç–µ —è–π—Ü–∞, –æ–±–∂–∞—Ä—å—Ç–µ —Å –ø–æ–º–∏–¥–æ—Ä–∞–º–∏'
                }
            }
        };

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –û–ë–õ–ê–ß–ù–û–ì–û –•–†–ê–ù–ò–õ–ò–©–ê ===
const CLOUD_STORAGE_URL = 'https://script.google.com/macros/s/AKfycbxoQHnbuXTnOpr6aHtIGAFzZcO7MD-Dih8IgbFW8G6Dt9qXnwQs2ZXxbfdx-7j0cbnc/exec'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL –∏–∑ —à–∞–≥–∞ 2.7

// –§–ª–∞–≥–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
let autoSaveEnabled = true;
let saveTimeout = null;

        // –¢–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è)
        let kbjuTable = {};

        const days = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
        let mealTimes = {
    '–ó–∞–≤—Ç—Ä–∞–∫': '08:00',
    '–û–±–µ–¥': '13:00', 
    '–£–∂–∏–Ω': '19:00'
};

let calculationsBtn;
let kbjuBtn;

        let currentDay = '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫';

        function saveData() {
            localStorage.setItem('savedMenuData', JSON.stringify(menuData));
            localStorage.setItem('savedKbjuTable', JSON.stringify(kbjuTable));
            localStorage.setItem('savedMealTimes', JSON.stringify(mealTimes));
        }

        function loadSavedData() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
            const savedMealTimes = localStorage.getItem('savedMealTimes');
            if (savedMealTimes) {
                Object.assign(mealTimes, JSON.parse(savedMealTimes));
            }
            
            const savedMenuData = localStorage.getItem('savedMenuData');
            const savedKbjuTable = localStorage.getItem('savedKbjuTable');
            
            if (savedMenuData) {
                try {
                    const parsedData = JSON.parse(savedMenuData);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
                    Object.values(parsedData).forEach(day => {
                        Object.values(day).forEach(meal => {
                            meal.ingredients.forEach(ingredient => {
                                if (!ingredient.originalName) {
                                    ingredient.originalName = ingredient.name;
                                }
                                if (!ingredient.status) {
                                    ingredient.status = kbjuTable[ingredient.name] ? 'exact' : 'not_found';
                                }
                                if (!ingredient.suggestions) {
                                    ingredient.suggestions = [];
                                }
                            });
                        });
                    });
                    menuData = parsedData;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ menuData:', e);
                }
            }
            
            if (savedKbjuTable) {
                try {
                    kbjuTable = JSON.parse(savedKbjuTable);
                    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                    const loadMenuBtn = document.getElementById('loadMenuBtn');
                    if (loadMenuBtn) {
                        loadMenuBtn.disabled = false;
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ kbjuTable:', e);
                }
            } else {
                const loadMenuBtn = document.getElementById('loadMenuBtn');
                if (loadMenuBtn) {
                    loadMenuBtn.disabled = true;
                }
            }
        }

// === –§–£–ù–ö–¶–ò–ò –ê–í–¢–û–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
function autoSaveToCloud() {
    if (!autoSaveEnabled) return;
    
    // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö)
    saveTimeout = setTimeout(() => {
        saveToCloud().catch(error => {
            console.warn('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', error);
        });
    }, 2000);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ —á–µ—Ä–µ–∑ JSONP
function saveToCloud() {
    return new Promise((resolve, reject) => {
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ...');
        
        const dataToSave = {
            menuData: menuData,
            kbjuTable: kbjuTable,
            mealTimes: mealTimes,
            lastUpdated: new Date().toISOString()
        };
        
        // –°–æ–∑–¥–∞–µ–º callback —Ñ—É–Ω–∫—Ü–∏—é
        window.cloudSaveCallback = function(response) {
            if (response.success) {
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ');
                resolve(true);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', response.error);
                reject(new Error(response.error));
            }
        };
        
        // –°–æ–∑–¥–∞–µ–º script —Ç–µ–≥ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
        const script = document.createElement('script');
        script.src = `${CLOUD_STORAGE_URL}?action=save&callback=cloudSaveCallback&data=${encodeURIComponent(JSON.stringify(dataToSave))}`;
        document.head.appendChild(script);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞ —á–µ—Ä–µ–∑ JSONP
function loadFromCloud() {
    return new Promise((resolve, reject) => {
        console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞...');
        
        // –°–æ–∑–¥–∞–µ–º callback —Ñ—É–Ω–∫—Ü–∏—é
        window.cloudLoadCallback = function(response) {
    console.log('üì® –û—Ç–≤–µ—Ç –æ—Ç –æ–±–ª–∞–∫–∞:', response);
    
    if (response.success && response.data) {
        try {
            console.log('üìù –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', response.data);
            const savedData = JSON.parse(response.data);
            console.log('üìä –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', savedData);
            
            menuData = savedData.menuData || {};
            kbjuTable = savedData.kbjuTable || {};
            mealTimes = savedData.mealTimes || {};
            
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
            resolve(true);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', error);
            reject(error);
        }
    } else {
        console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ –∏–ª–∏ –æ—à–∏–±–∫–∞:', response.error);
        resolve(false);
    }
};
        
        // –°–æ–∑–¥–∞–µ–º script —Ç–µ–≥ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
        const script = document.createElement('script');
        script.src = `${CLOUD_STORAGE_URL}?action=load&callback=cloudLoadCallback`;
        document.head.appendChild(script);
        
        // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        setTimeout(() => {
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            console.log('‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞');
            resolve(false);
        }, 5000);
    });
}

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
async function autoLoadFromCloud() {
    const success = await loadFromCloud();
    if (success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        loadSavedData();
        showDayData(currentDay);
        updateKbjuTableDisplay();
        console.log('‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω —Å –æ–±–ª–∞—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
    }
}

function init() {
    console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
    loadFromCloud().then(success => {
        if (success) {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –æ–±–ª–∞—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            loadSavedData();
            createDayNavigation();
            showDayData(currentDay);
            updateKbjuTableDisplay();
        } else {
            console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –∏–∑ localStorage
            loadSavedData();
            createDayNavigation();
            showDayData(currentDay);
            updateKbjuTableDisplay();
        }
    }).catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ –æ–±–ª–∞–∫–∞:', error);
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        loadSavedData();
        createDayNavigation();
        showDayData(currentDay);
        updateKbjuTableDisplay();
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        saveToCloud().catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
        });
    });
}

        function createDayNavigation() {
            const daysNav = document.getElementById('daysNav');
            daysNav.innerHTML = '';
            
            days.forEach(day => {
                const button = document.createElement('button');
                button.className = `day-btn ${day === currentDay ? 'active' : ''}`;
                button.textContent = day.substring(0, 2);
                button.onclick = () => {
                    currentDay = day;
                    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
                    updateActiveNavigation(button);
                    showDayData(day);
                };
                daysNav.appendChild(button);
            });

            calculationsBtn = document.createElement('button');
            calculationsBtn.className = 'day-btn';
            calculationsBtn.textContent = '–ü–æ–¥—Å—á–µ—Ç—ã';
            calculationsBtn.onclick = showCalculations;
            daysNav.appendChild(calculationsBtn);

            kbjuBtn = document.createElement('button');
            kbjuBtn.className = 'day-btn';
            kbjuBtn.textContent = '–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤';
            kbjuBtn.onclick = showKbjuTable;
            daysNav.appendChild(kbjuBtn);
        }

        function showDayData(dayName) {
            document.getElementById('menuContent').style.display = 'block';
            document.getElementById('calculationsSection').style.display = 'none';
            document.getElementById('kbjuTableSection').style.display = 'none';

            const tableBody = document.getElementById('menuTableBody');
            const dayData = menuData[dayName] || {};
            
            let html = '';
            let dayTotal = { proteins: 0, fats: 0, carbs: 0, calories: 0 };

            Object.entries(dayData).forEach(([meal, mealData]) => {
                const mealTime = mealTimes[meal] || '';
                const mealTotal = calculateMealTotal(mealData.ingredients);
                const ingredientCount = mealData.ingredients.length;
                
                if (ingredientCount === 0) return;

                dayTotal.proteins += mealTotal.proteins;
                dayTotal.fats += mealTotal.fats;
                dayTotal.carbs += mealTotal.carbs;
                dayTotal.calories += mealTotal.calories;

                // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ —è—á–µ–π–∫–∞–º–∏
                const firstIngredient = mealData.ingredients[0];
                html += `
                    <tr>
                        <td rowspan="${ingredientCount + 1}" class="time-cell">
                            <div class="time-display" onclick="showTimeDropdown(this, '${dayName}', '${meal}')">
                                ${mealTime || '--:--'}
                            </div>
                        </td>
                        <td rowspan="${ingredientCount + 1}">${meal}</td>
                        <td rowspan="${ingredientCount + 1}" class="dish-cell">
    ${mealData.dish}
    <button class="dish-add-btn" onclick="openProductSelectModal('${dayName}', '${meal}')">+</button>

</td>
                        <td class="ingredient-cell ${firstIngredient.status === 'not_found' ? 'ingredient-not-found' : ''}">
                            ${firstIngredient.originalName || firstIngredient.name}
                            ${firstIngredient.status !== 'exact' ? 
                                `<button class="suggest-btn" onclick="showSuggestions(this, '${dayName}', '${meal}', 0)">?</button>` : 
                                `<button class="delete-btn" onclick="deleteIngredient('${dayName}', '${meal}', 0)">‚úï</button>`
                            }
                        </td>
                        <td>
                            <input type="number" class="weight-input" value="${firstIngredient.weight}" 
                                   onchange="updateWeight('${dayName}', '${meal}', 0, this.value)">
                        </td>
                        <td>${firstIngredient.proteins.toFixed(1)}</td>
                        <td>${firstIngredient.fats.toFixed(1)}</td>
                        <td>${firstIngredient.carbs.toFixed(1)}</td>
                        <td>${firstIngredient.calories.toFixed(1)}</td>
                        <td rowspan="${ingredientCount + 1}">${mealData.recipe}</td>
                    </tr>`;

                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                for (let i = 1; i < ingredientCount; i++) {
                    const ingredient = mealData.ingredients[i];
                    html += `
                        <tr>
                            <td class="ingredient-cell ${ingredient.status === 'not_found' ? 'ingredient-not-found' : ''}">
                                ${ingredient.originalName || ingredient.name}
                                ${ingredient.status !== 'exact' ? 
                                    `<button class="suggest-btn" onclick="showSuggestions(this, '${dayName}', '${meal}', ${i})">?</button>` : 
                                    `<button class="delete-btn" onclick="deleteIngredient('${dayName}', '${meal}', ${i})">‚úï</button>`
                                }
                            </td>
                            <td>
                                <input type="number" class="weight-input" value="${ingredient.weight}" 
                                       onchange="updateWeight('${dayName}', '${meal}', ${i}, this.value)">
                            </td>
                            <td>${ingredient.proteins.toFixed(1)}</td>
                            <td>${ingredient.fats.toFixed(1)}</td>
                            <td>${ingredient.carbs.toFixed(1)}</td>
                            <td>${ingredient.calories.toFixed(1)}</td>
                        </tr>`;
                }

                
                // –ò—Ç–æ–≥ –ø–æ –ø—Ä–∏–µ–º—É –ø–∏—â–∏
                html += `
                    <tr class="meal-total-row">
                        <td colspan="1" style="text-align: right;">–ò—Ç–æ–≥–æ ${meal}:</td>
                        <td></td>
                        <td>${mealTotal.proteins.toFixed(1)}</td>
                        <td>${mealTotal.fats.toFixed(1)}</td>
                        <td>${mealTotal.carbs.toFixed(1)}</td>
                        <td>${mealTotal.calories.toFixed(1)}</td>
                        
                    </tr>
                    <tr class="meal-spacer"><td colspan="10"></td></tr>`;
            });

            // –û–±—â–∏–π –∏—Ç–æ–≥ –¥–Ω—è
            html += `
                <tr class="day-total-row">
                    <td colspan="4" style="text-align: right;">–í–°–ï–ì–û –∑–∞ –¥–µ–Ω—å:</td>
                    <td></td>
                    <td>${dayTotal.proteins.toFixed(1)}</td>
                    <td>${dayTotal.fats.toFixed(1)}</td>
                    <td>${dayTotal.carbs.toFixed(1)}</td>
                    <td>${dayTotal.calories.toFixed(1)}</td>
                    
                </tr>`;

            tableBody.innerHTML = html;
            document.getElementById('menuTitle').textContent = `–ú–µ–Ω—é –Ω–∞ ${dayName.toLowerCase()}`;
        }

        function calculateMealTotal(ingredients) {
            let total = { proteins: 0, fats: 0, carbs: 0, calories: 0 };
            ingredients.forEach(ingredient => {
                total.proteins += ingredient.proteins;
                total.fats += ingredient.fats;
                total.carbs += ingredient.carbs;
                total.calories += ingredient.calories;
            });
            return total;
        }

        function updateWeight(day, meal, index, newWeight) {
            const weight = parseInt(newWeight) || 0;
            const ingredient = menuData[day][meal].ingredients[index];
            
            ingredient.weight = weight;
            
            if (kbjuTable[ingredient.name]) {
                const kbjuData = kbjuTable[ingredient.name];
                const ratio = weight / 100;
                
                ingredient.proteins = kbjuData.proteins * ratio;
                ingredient.fats = kbjuData.fats * ratio;
                ingredient.carbs = kbjuData.carbs * ratio;
                ingredient.calories = kbjuData.calories * ratio;
            }
            
            showDayData(currentDay);
            autoSaveToCloud();
        }

function addIngredient(day, meal) {
    if (!menuData[day]) menuData[day] = {};
    if (!menuData[day][meal]) {
        menuData[day][meal] = {
            dish: '–ù–æ–≤–æ–µ –±–ª—é–¥–æ',
            ingredients: [],
            recipe: ''
        };
    }
    
    menuData[day][meal].ingredients.push({
        name: '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç',
        originalName: '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç',
        weight: 100,
        proteins: 0,
        fats: 0,
        carbs: 0,
        calories: 0,
        status: 'not_found',
        suggestions: []
    });
    
    saveData(); // ‚Üê –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    showDayData(currentDay);
    autoSaveToCloud(); 
}
        function deleteIngredient(day, meal, index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç?')) {
        menuData[day][meal].ingredients.splice(index, 1);
        saveData(); // ‚Üê –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£
        showDayData(currentDay);
        autoSaveToCloud();
    }
}

        function showCalculations() {
updateActiveNavigation(calculationsBtn);
            document.getElementById('menuContent').style.display = 'none';
            document.getElementById('calculationsSection').style.display = 'block';
            document.getElementById('kbjuTableSection').style.display = 'none';
            
            const productCount = {};
Object.values(menuData).forEach(day => {
    Object.values(day).forEach(meal => {
        meal.ingredients.forEach(ingredient => {
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ - —Ç–æ–ª—å–∫–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
            if (ingredient.status === 'exact') {
                const productName = ingredient.name;
                productCount[productName] = (productCount[productName] || 0) + ingredient.weight;
            }
        });
    });
});
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr><th style="text-align: left; padding: 10px; border-bottom: 1px solid var(--border);">–ü—Ä–æ–¥—É–∫—Ç</th><th style="text-align: left; padding: 10px; border-bottom: 1px solid var(--border);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≥—Ä)</th></tr>';
            
            Object.entries(productCount).forEach(([product, amount]) => {
                html += `<tr><td style="padding: 8px; border-bottom: 1px solid var(--border);">${product}</td><td style="padding: 8px; border-bottom: 1px solid var(--border);">${Math.round(amount)}</td></tr>`;
            });
            
            html += '</table>';
            document.getElementById('calculationsContent').innerHTML = html;
        }

        function showKbjuTable() {
updateActiveNavigation(kbjuBtn);
            document.getElementById('menuContent').style.display = 'none';
            document.getElementById('calculationsSection').style.display = 'none';
            document.getElementById('kbjuTableSection').style.display = 'block';
        }

        function parseKbjuTxtData(content) {
    const lines = content.split('\n');
    let newProductsLoaded = 0;
    let productsLoaded = 0; // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É
            
            lines.forEach((line, index) => {
                const cleanLine = line.trim();
                
                if (!cleanLine || 
                    cleanLine.startsWith('–¢–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£') || 
                    cleanLine.startsWith('‚Ññ\t') ||
                    cleanLine === '‚Ññ\t–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ\t–ë\t–ñ\t–£\t–ö–ö–ª' ||
                    cleanLine.startsWith('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ')) {
                    return;
                }
                
                const parts = cleanLine.split('\t').filter(part => part.trim());
                
                if (parts.length === 6) {
                    try {
                        const productName = parts[1].trim();
                        const proteins = parseFloat(parts[2].replace(',', '.'));
                        const fats = parseFloat(parts[3].replace(',', '.'));
                        const carbs = parseFloat(parts[4].replace(',', '.'));
                        const calories = parseFloat(parts[5].replace(',', '.'));
                        
                        if (!kbjuTable[productName]) {
    kbjuTable[productName] = {
        proteins: proteins,
        fats: fats,
        carbs: carbs,
        calories: calories
    };
    newProductsLoaded++; // –£–±–∏—Ä–∞–µ–º productsLoaded++, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ newProductsLoaded++
}
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏', index + 1, ':', cleanLine, error);
                    }
                }
            });
            
            if (newProductsLoaded === 0) {
    // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º —á—Ç–æ –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–µ—Ç
    console.log('–ù–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
}

return newProductsLoaded; // ‚Üê –≠—Ç—É —Å—Ç—Ä–æ–∫—É –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–∞–º—ã–π –∫–æ–Ω–µ—Ü
        }

function updateKbjuTableDisplay() {
    if (Object.keys(kbjuTable).length === 0) {
        document.getElementById('kbjuTableContent').innerHTML = 
            '<p style="text-align: center; color: var(--text-secondary); margin: 40px;">–¢–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>';
        return;
    }
    
    let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
    html += '<tr><th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--accent);">‚Ññ</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--accent);">–ü—Ä–æ–¥—É–∫—Ç</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--accent);">–ë–µ–ª–∫–∏</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--accent);">–ñ–∏—Ä—ã</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--accent);">–£–≥–ª–µ–≤–æ–¥—ã</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--accent);">–ö–∫–∞–ª</th><th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--accent);">–î–µ–π—Å—Ç–≤–∏—è</th></tr>';
    
    Object.entries(kbjuTable).forEach(([product, data], index) => {
        const formatValue = (num) => {
            if (Number.isInteger(num)) return num.toString();
            const rounded = Math.round(num * 10) / 10;
            return rounded % 1 === 0 ? rounded.toString() : rounded.toFixed(1);
        };
        
        html += `<tr>
    <td style="text-align: center; padding: 8px; border-bottom: 1px solid var(--border);">${index + 1}</td>
    <td style="padding: 8px; border-bottom: 1px solid var(--border);">${product}</td>
    <td style="padding: 8px; border-bottom: 1px solid var(--border);">${formatValue(data.proteins)}</td>
    <td style="padding: 8px; border-bottom: 1px solid var(--border);">${formatValue(data.fats)}</td>
    <td style="padding: 8px; border-bottom: 1px solid var(--border);">${formatValue(data.carbs)}</td>
    <td style="padding: 8px; border-bottom: 1px solid var(--border);">${formatValue(data.calories)}</td>
    <td style="padding: 8px; border-bottom: 1px solid var(--border);">
        <button class="control-btn" style="padding: 4px 8px; font-size: 12px;" onclick="editProductByIndex(${index})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </td>
</tr>`;
    });
    
    html += '</table>';
    document.getElementById('kbjuTableContent').innerHTML = html;
}
        function findProductInKbju(ingredientName) {
            const exactMatch = Object.keys(kbjuTable).find(product => 
                product.toLowerCase() === ingredientName.toLowerCase()
            );
            
            if (exactMatch) {
                return { match: exactMatch, type: 'exact' };
            }
            
            const partialMatches = Object.keys(kbjuTable).filter(product => {
                const productLower = product.toLowerCase();
                const ingredientLower = ingredientName.toLowerCase();
                
                return productLower.includes(ingredientLower) || 
                       ingredientLower.includes(productLower) ||
                       productLower.split(/\s+/).some(word => ingredientLower.includes(word)) ||
                       ingredientLower.split(/\s+/).some(word => productLower.includes(word));
            });
            
            if (partialMatches.length > 0) {
                return { match: partialMatches[0], type: 'partial', allMatches: partialMatches };
            }
            
            return { match: null, type: 'not_found' };
        }

        function parseMenuTxtData(content) {
            const lines = content.split('\n');
            const newMenuData = {};
            
            let currentDay = '';
            let currentMeal = '';
            let currentDish = '';
            let currentIngredients = [];
            let currentRecipe = '';
            let parsingIngredients = false;
            let parsingRecipe = false;
            
            lines.forEach((line, index) => {
                const cleanLine = line.trim();
                
                if (!cleanLine) return;
                
                const dayMatch = cleanLine.match(/^(–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫|–í—Ç–æ—Ä–Ω–∏–∫|–°—Ä–µ–¥–∞|–ß–µ—Ç–≤–µ—Ä–≥|–ü—è—Ç–Ω–∏—Ü–∞|–°—É–±–±–æ—Ç–∞|–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)$/);
                if (dayMatch) {
                    if (currentDay && currentMeal) {
                        saveMealToMenuData(newMenuData, currentDay, currentMeal, currentDish, currentIngredients, currentRecipe);
                    }
                    
                    currentDay = dayMatch[0];
                    currentMeal = '';
                    currentDish = '';
                    currentIngredients = [];
                    currentRecipe = '';
                    parsingIngredients = false;
                    parsingRecipe = false;
                    return;
                }
                
                const mealMatch = cleanLine.match(/^(\d*–π\s*)?(–ø–µ—Ä–µ–∫—É—Å|–ó–∞–≤—Ç—Ä–∞–∫|–û–±–µ–¥|–£–∂–∏–Ω):?$/i);
                if (mealMatch && currentDay) {
                    if (currentMeal) {
                        saveMealToMenuData(newMenuData, currentDay, currentMeal, currentDish, currentIngredients, currentRecipe);
                    }
                    
                    const mealType = mealMatch[2].charAt(0).toUpperCase() + mealMatch[2].slice(1).toLowerCase();
                    currentMeal = mealMatch[1] ? `${mealMatch[1]}${mealType}` : mealType;
                    currentDish = '';
                    currentIngredients = [];
                    currentRecipe = '';
                    parsingIngredients = false;
                    parsingRecipe = false;
                    return;
                }
                
                if (currentDay && currentMeal) {
                    if (!currentDish && !cleanLine.toLowerCase().includes('—Å–æ—Å—Ç–∞–≤:') && 
                        !cleanLine.toLowerCase().includes('–∫–±–∂—É:') && 
                        !cleanLine.toLowerCase().includes('–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:')) {
                        currentDish = cleanLine;
                        return;
                    }
                    
                    if (cleanLine.toLowerCase().includes('—Å–æ—Å—Ç–∞–≤:')) {
                        parsingIngredients = true;
                        parsingRecipe = false;
                        return;
                    }
                    
                    if (cleanLine.toLowerCase().includes('–∫–±–∂—É:')) {
                        parsingIngredients = false;
                        return;
                    }
                    
                    if (cleanLine.toLowerCase().includes('–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:')) {
                        parsingRecipe = true;
                        parsingIngredients = false;
                        return;
                    }
                    
                    if (parsingIngredients) {
                        const ingredientMatch = cleanLine.match(/^([^‚Äì‚Äî\-]+)[‚Äì‚Äî\-]\s*(\d+)\s*–≥?$/);
                        if (ingredientMatch) {
                            const ingredientName = ingredientMatch[1].trim();
                            const weight = parseInt(ingredientMatch[2]);
                            
                            const searchResult = findProductInKbju(ingredientName);
                            
                            if (searchResult.type === 'exact' || searchResult.type === 'partial') {
                                const kbjuData = kbjuTable[searchResult.match];
                                const ratio = weight / 100;
                                currentIngredients.push({
                                    name: searchResult.match,
                                    originalName: ingredientName,
                                    weight: weight,
                                    proteins: kbjuData.proteins * ratio,
                                    fats: kbjuData.fats * ratio,
                                    carbs: kbjuData.carbs * ratio,
                                    calories: kbjuData.calories * ratio,
                                    status: searchResult.type === 'exact' ? 'exact' : 'partial',
                                    suggestions: searchResult.allMatches || []
                                });
                            } else {
                                currentIngredients.push({
                                    name: ingredientName,
                                    originalName: ingredientName,
                                    weight: weight,
                                    proteins: 0,
                                    fats: 0,
                                    carbs: 0,
                                    calories: 0,
                                    status: 'not_found',
                                    suggestions: []
                                });
                            }
                        }
                        return;
                    }
                    
                    if (parsingRecipe) {
                        if (currentRecipe) {
                            currentRecipe += ' ' + cleanLine;
                        } else {
                            currentRecipe = cleanLine;
                        }
                        return;
                    }
                }
            });
            
            if (currentDay && currentMeal) {
                saveMealToMenuData(newMenuData, currentDay, currentMeal, currentDish, currentIngredients, currentRecipe);
            }
            
            return newMenuData;
        }

        function saveMealToMenuData(menuData, day, meal, dish, ingredients, recipe) {
            if (!menuData[day]) menuData[day] = {};
            
            menuData[day][meal] = {
                dish: dish,
                ingredients: ingredients,
                recipe: recipe
            };
        }

       function loadMenuFromTxt() {
    if (Object.keys(kbjuTable).length === 0) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ö–ë–ñ–£!');
        return;
    }
    
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.txt';
    
    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const newMenuData = parseMenuTxtData(content);
                
                Object.keys(newMenuData).forEach(day => {
                    if (!menuData[day]) {
                        menuData[day] = {};
                    }
                    Object.keys(newMenuData[day]).forEach(meal => {
                        menuData[day][meal] = newMenuData[day][meal];
                    });
                });
                
                showDayData(currentDay);
                saveData();
                
               // –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –°–¢–†–û–ö–ò:
    saveToCloud().then(() => {
        console.log('‚úÖ –ú–µ–Ω—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ');
    }).catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–Ω—é –≤ –æ–±–ª–∞–∫–æ:', error);
    });
                
                alert('–ú–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é: ' + error.message);
            }
        };
        reader.readAsText(file);
    };
    
    fileInput.click();
}

        function showSuggestions(button, day, meal, index) {
            const existingDropdowns = document.querySelectorAll('.suggestions-dropdown');
            existingDropdowns.forEach(dropdown => dropdown.remove());
            
            const ingredient = menuData[day][meal].ingredients[index];
            const suggestions = ingredient.suggestions.length > 0 ? 
                ingredient.suggestions : 
                Object.keys(kbjuTable).filter(product => 
                    product.toLowerCase().includes(ingredient.originalName.toLowerCase()) ||
                    ingredient.originalName.toLowerCase().includes(product.toLowerCase())
                );
            
            const dropdown = document.createElement('div');
            dropdown.className = 'suggestions-dropdown';
            
            suggestions.forEach(product => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = product;
                item.onclick = function() {
                    replaceIngredient(day, meal, index, product);
                    dropdown.remove();
                };
                dropdown.appendChild(item);
            });
            
            if (suggestions.length === 0) {
                Object.keys(kbjuTable).forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = product;
                    item.onclick = function() {
                        replaceIngredient(day, meal, index, product);
                        dropdown.remove();
                    };
                    dropdown.appendChild(item);
                });
            }
            
            const buttonRect = button.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.left = buttonRect.left + 'px';
            dropdown.style.top = (buttonRect.bottom + 5) + 'px';
            
            document.body.appendChild(dropdown);
            
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== button) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }

        function replaceIngredient(day, meal, index, newProductName) {
            const ingredient = menuData[day][meal].ingredients[index];
            const kbjuData = kbjuTable[newProductName];
            const ratio = ingredient.weight / 100;
            
            ingredient.name = newProductName;
            ingredient.originalName = newProductName;
            ingredient.proteins = kbjuData.proteins * ratio;
            ingredient.fats = kbjuData.fats * ratio;
            ingredient.carbs = kbjuData.carbs * ratio;
            ingredient.calories = kbjuData.calories * ratio;
            ingredient.status = 'exact';
            ingredient.suggestions = [];
            
            saveData();
            showDayData(currentDay);
        }

        function loadKbjuFromTxt() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.txt';
    
    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const newProductsCount = parseKbjuTxtData(content);
                updateKbjuTableDisplay();
                
                const loadMenuBtn = document.getElementById('loadMenuBtn');
                if (loadMenuBtn) {
                    loadMenuBtn.disabled = false;
                }
                
                saveData();
                
                   // –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –°–¢–†–û–ö–ò:
    saveToCloud().then(() => {
        console.log('‚úÖ –ö–ë–ñ–£ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ');
    }).catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ö–ë–ñ–£ –≤ –æ–±–ª–∞–∫–æ:', error);
    });
                
                alert('–¢–∞–±–ª–∏—Ü–∞ –ö–ë–ñ–£ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ' + newProductsCount + '. –í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ: ' + Object.keys(kbjuTable).length);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∞–±–ª–∏—Ü—ã –ö–ë–ñ–£: ' + error.message);
            }
        };
        reader.readAsText(file);
    };
    
    fileInput.click();
}

function showTimeDropdown(element, day, meal) {
    const existingDropdowns = document.querySelectorAll('.time-dropdown');
    existingDropdowns.forEach(dropdown => dropdown.remove());
    
    const dropdown = document.createElement('div');
    dropdown.className = 'time-dropdown';
    
    // –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç 01:00 –¥–æ 23:00 —Å —à–∞–≥–æ–º –≤ 1 —á–∞—Å
    for (let hour = 1; hour <= 23; hour++) {
        const timeString = `${hour.toString().padStart(2, '0')}:00`;
        const option = document.createElement('div');
        option.className = 'time-option';
        option.textContent = timeString;
        option.onclick = function(e) {
            e.stopPropagation();
            updateMealTime(day, meal, timeString);
            dropdown.remove();
        };
        dropdown.appendChild(option);
    }
    
    const noTimeOption = document.createElement('div');
    noTimeOption.className = 'time-option';
    noTimeOption.textContent = '--:--';
    noTimeOption.onclick = function(e) {
        e.stopPropagation();
        updateMealTime(day, meal, '');
        dropdown.remove();
    };
    dropdown.appendChild(noTimeOption);
    
    const rect = element.getBoundingClientRect();
    dropdown.style.position = 'fixed';
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    
    document.body.appendChild(dropdown);
    
    setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && e.target !== element) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        });
    }, 100);
}        function updateMealTime(day, meal, newTime) {
            mealTimes[meal] = newTime;
            saveData();
            showDayData(currentDay);
            autoSaveToCloud();
        }

        document.addEventListener('DOMContentLoaded', init);

function addIngredientFromHeader() {
    if (currentDay && Object.keys(menuData[currentDay] || {}).length > 0) {
        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –ø—Ä–∏–µ–º –ø–∏—â–∏ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
        const firstMeal = Object.keys(menuData[currentDay])[0];
        addIngredient(currentDay, firstMeal);
    } else {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –∏ –ø—Ä–∏–µ–º –ø–∏—â–∏');
    }
}    

function showAddProductModal() {
    const modal = document.getElementById('addProductModal');
    modal.style.display = 'flex';
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –∏ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º
    document.getElementById('newProductName').value = '';
    document.getElementById('newProductProteins').value = '';
    document.getElementById('newProductFats').value = '';
    document.getElementById('newProductCarbs').value = '';
    document.getElementById('newProductCalories').value = '';
    
    document.getElementById('newProductName').focus();
// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
modal.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        hideAddProductModal();
    }
});
}

function hideAddProductModal() {
    const modal = document.getElementById('addProductModal');
    modal.style.display = 'none';
    delete modal.dataset.editingProduct;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é "–î–æ–±–∞–≤–∏—Ç—å"
    document.getElementById('modalActionButton').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
    document.getElementById('modalDeleteButton').style.display = 'none';
}

function addNewProduct() {
    const modal = document.getElementById('addProductModal');
    const name = document.getElementById('newProductName').value.trim();
    const proteins = parseFloat(document.getElementById('newProductProteins').value) || 0;
    const fats = parseFloat(document.getElementById('newProductFats').value) || 0;
    const carbs = parseFloat(document.getElementById('newProductCarbs').value) || 0;
    const calories = parseFloat(document.getElementById('newProductCalories').value) || 0;
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞');
        return;
    }
    
    const editingProduct = modal.dataset.editingProduct;
    
    if (editingProduct) {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
        if (editingProduct !== name) {
            // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞–∑–≤–∞–Ω–∏–µ - —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            delete kbjuTable[editingProduct];
        }
        kbjuTable[name] = {
            proteins: proteins,
            fats: fats,
            carbs: carbs,
            calories: calories
        };
    } else {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
        kbjuTable[name] = {
            proteins: proteins,
            fats: fats,
            carbs: carbs,
            calories: calories
        };
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    saveData();
    updateKbjuTableDisplay();
    hideAddProductModal();
    autoSaveToCloud();
    
    alert('–ü—Ä–æ–¥—É–∫—Ç "' + name + '" —É—Å–ø–µ—à–Ω–æ ' + (editingProduct ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω') + '!');
}
function editProduct(productName) {
    const productData = kbjuTable[productName];
    
    const modal = document.getElementById('addProductModal');
    modal.style.display = 'flex';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
    document.getElementById('newProductName').value = productName;
    document.getElementById('newProductProteins').value = productData.proteins;
    document.getElementById('newProductFats').value = productData.fats;
    document.getElementById('newProductCarbs').value = productData.carbs;
    document.getElementById('newProductCalories').value = productData.calories;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    modal.dataset.editingProduct = productName;
    
    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('modalActionButton').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    document.getElementById('modalDeleteButton').style.display = 'block';
    
    document.getElementById('newProductName').focus();
}

function deleteProduct() {
    const modal = document.getElementById('addProductModal');
    const productName = modal.dataset.editingProduct;
    
    if (productName && confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç "${productName}"?`)) {
        delete kbjuTable[productName];
        saveData();
        updateKbjuTableDisplay();
        hideAddProductModal();
        alert('–ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω!');
    }
}

function editProductByIndex(index) {
    const productName = Object.keys(kbjuTable)[index];
    editProduct(productName);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
        const addProductModal = document.getElementById('addProductModal');
        if (addProductModal && addProductModal.style.display === 'flex') {
            hideAddProductModal();
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–æ–≤–æ–µ)
        const productSelectModal = document.getElementById('productSelectModal');
        if (productSelectModal && productSelectModal.style.display === 'flex') {
            closeProductSelectModal();
        }

        // –í—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é –ø–æ–¥—Å–∫–∞–∑–æ–∫
        document.querySelectorAll('.suggestions-dropdown').forEach(dropdown => dropdown.remove());

        // –í—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é –≤—Ä–µ–º–µ–Ω–∏
        document.querySelectorAll('.time-dropdown').forEach(dropdown => dropdown.remove());
    }
});


function updateActiveNavigation(activeButton) {
    // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.day-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –î–µ–ª–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
    if (activeButton) {
        activeButton.classList.add('active');
    }
}

let currentAddTarget = null; // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫—É–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–æ–¥—É–∫—Ç

function openProductSelectModal(day, meal) {
    currentAddTarget = { day, meal };
    const modal = document.getElementById('productSelectModal');
    const container = document.getElementById('productSelectTableContainer');

    if (Object.keys(kbjuTable).length === 0) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ö–ë–ñ–£!');
        return;
    }

    // –≤—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤
    const maxProductNameLength = Math.max(...Object.keys(kbjuTable).map(name => name.length), 10);
    const productColWidth = `${maxProductNameLength * 8}px`; // —à–∏—Ä–∏–Ω–∞ –ø–æ –¥–ª–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞
    const nutrientColWidth = '80px'; // –ø–æ —à–∏—Ä–∏–Ω–µ —Å–ª–æ–≤–∞ "–£–≥–ª–µ–≤–æ–¥—ã"

    let html = `
    <table style="
        border-collapse: collapse; 
        width: max-content; 
        margin: 0 auto; 
        border: 1px solid var(--border);
    ">
        <thead style="
            position: sticky; 
            top: 0; 
            z-index: 5; 
            background: var(--accent); 
            box-shadow: 0 2px 3px rgba(0,0,0,0.4);
        ">
            <tr style="color: white; text-align: center;">
                <th style="padding: 8px; border: 1px solid var(--border); text-align: left; min-width: ${productColWidth};">–ü—Ä–æ–¥—É–∫—Ç</th>
                <th style="padding: 8px; border: 1px solid var(--border); min-width: ${nutrientColWidth};">–ë–µ–ª–∫–∏</th>
                <th style="padding: 8px; border: 1px solid var(--border); min-width: ${nutrientColWidth};">–ñ–∏—Ä—ã</th>
                <th style="padding: 8px; border: 1px solid var(--border); min-width: ${nutrientColWidth};">–£–≥–ª–µ–≤–æ–¥—ã</th>
                <th style="padding: 8px; border: 1px solid var(--border); min-width: ${nutrientColWidth};">–ö–∫–∞–ª</th>
            </tr>
        </thead>
        <tbody>
`;


    const products = Object.entries(kbjuTable);
    products.forEach(([name, data]) => {
        html += `
            <tr class="product-row" 
    style="cursor: pointer; text-align: center;"
    ontouchstart="handleTouchStart(event, '${name.replace(/'/g, "\\'")}')"
    ontouchmove="handleTouchMove(event)"
    ontouchend="handleTouchEnd(event)"
    onclick="handleMouseClick('${name.replace(/'/g, "\\'")}')">
    <td style="padding: 6px; border: 1px solid var(--border); text-align: left;">${name}</td>
    <td style="padding: 6px; border: 1px solid var(--border);">${data.proteins.toFixed(1)}</td>
    <td style="padding: 6px; border: 1px solid var(--border);">${data.fats.toFixed(1)}</td>
    <td style="padding: 6px; border: 1px solid var(--border);">${data.carbs.toFixed(1)}</td>
    <td style="padding: 6px; border: 1px solid var(--border);">${data.calories.toFixed(1)}</td>
</tr>


        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;

    modal.style.display = 'flex';
}

function closeProductSelectModal() {
    document.getElementById('productSelectModal').style.display = 'none';
    currentAddTarget = null;
}

function selectProduct(productName) {
    if (!currentAddTarget) return;

    const { day, meal } = currentAddTarget;
    const kbjuData = kbjuTable[productName];
    const weight = 100; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–±–∞–≤–ª—è–µ–º 100 –≥
    const ratio = weight / 100;

    const ingredient = {
        name: productName,
        originalName: productName,
        weight: weight,
        proteins: kbjuData.proteins * ratio,
        fats: kbjuData.fats * ratio,
        carbs: kbjuData.carbs * ratio,
        calories: kbjuData.calories * ratio,
        status: 'exact',
        suggestions: []
    };

    menuData[day][meal].ingredients.push(ingredient);
    saveData();
    showDayData(currentDay);
    closeProductSelectModal();
}

let touchStartY = 0;
let touchMoved = false;
let touchProduct = null;

// –Ω–∞—á–∞–ª–æ –∫–∞—Å–∞–Ω–∏—è
function handleTouchStart(e, productName) {
    touchStartY = e.touches[0].clientY;
    touchMoved = false;
    touchProduct = productName;
}

// –¥–≤–∏–∂–µ–Ω–∏–µ –ø–∞–ª—å—Ü–µ–º (–ø—Ä–æ–∫—Ä—É—Ç–∫–∞)
function handleTouchMove(e) {
    const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
    if (deltaY > 10) { // –µ—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –±–æ–ª—å—à–µ 10 –ø–∏–∫—Å–µ–ª–µ–π ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Å–∫—Ä–æ–ª–ª
        touchMoved = true;
    }
}

// –∫–æ–Ω–µ—Ü –∫–∞—Å–∞–Ω–∏—è
function handleTouchEnd(e) {
    if (!touchMoved && touchProduct) {
        selectProduct(touchProduct); // –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–ø = –≤—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞
    }
    touchProduct = null;
}

// –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –º—ã—à—å—é (–¥–µ—Å–∫—Ç–æ–ø)
function handleMouseClick(productName) {
    selectProduct(productName);
}


</script>
</body>
</html>







